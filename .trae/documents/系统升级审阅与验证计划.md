# 系统升级审阅与验证计划

为了确保“多策略并行执行”与“会话存储优化”功能的正确性与稳定性，制定以下详细的审阅与验证计划。

## 1. 代码逻辑静态审阅 (Code Review)

### 1.1 并发安全性检查
- **目标**: 确认多线程环境下不存在资源竞争。
- **检查点**:
    - [x] `src/memory.py`: 确认 `ConversationMemory` 在初始化时正确接收 `skip_index` 参数，并在 `save()` 方法中根据该参数决定是否跳过全局索引更新。
    - [x] `src/strategies/base.py`: 确认 `_get_or_create_memory` 在接收到 `session_path` 时强制设置 `skip_index=True`。

### 1.2 会话路径生成逻辑
- **目标**: 确保生成的文件夹路径合法、语义清晰且无文件名冲突。
- **检查点**:
    - [x] `src/data_processor.py`: 检查文件名清洗逻辑（`re.sub`），确保去除 Windows/Linux 不支持的字符（如 `?`, `:`, `*` 等）。
    - [x] `src/data_processor.py`: 确认 `paper_id` 包含序号（如 `001_`），防止同名论文覆盖。

### 1.3 策略隔离性
- **目标**: 确保不同策略之间的数据绝对隔离。
- **检查点**:
    - [x] `src/data_processor.py`: 确认在 `ThreadPoolExecutor` 中，每个任务都使用了独立的 `strategy.process` 调用，并且传入了独立的 `session_path`。

## 2. 动态验证测试 (Verification Testing)

我建议创建一个轻量级的验证脚本 `scripts/verify_update.py`，自动执行以下测试用例：

### 测试用例 A: 基础功能验证
- **输入**: 使用项目中的 `Data/train/test1.xlsx`，限制处理 1 篇论文 (`limit=1`)。
- **配置**: 启用所有策略 (`strategy='all'`)。
- **预期结果**:
    1.  控制台无报错，进度条正常显示。
    2.  `Data/test1/output/` 下生成 5 个 Excel 文件。
    3.  `history/sessions/test1/001_{Title}/` 目录下生成 5 个 JSON 文件（single.json, cot.json 等）。

### 测试用例 B: 文件名健壮性测试
- **输入**: 模拟一篇标题包含特殊字符（如 `Urban Renewal: A "New" Era?`）的论文。
- **预期结果**:
    - 程序不崩溃。
    - 生成的文件夹名为清洗后的版本（如 `Urban_Renewal_A_New_Era`）。

### 测试用例 C: 索引锁验证
- **输入**: 并发执行。
- **预期结果**: `history/index.json` 不会被修改（因为批量模式下禁用了索引），从而避免文件锁冲突。

## 3. 下一步执行计划 (Action Items)

如果您批准此计划，我将执行以下操作：
1.  **创建验证脚本**: 编写 `scripts/verify_update.py` 以便一键验证上述逻辑。
2.  **执行验证**: 运行脚本并向您汇报结果。
3.  **清理现场**: 验证通过后删除临时测试生成的文件。
