# 项目审查报告：提示词与代码逻辑

我已对所有指标的提示词（Prompt Templates）以及每个策略的代码逻辑（Strategy Implementation）进行了全面审查。

## 1. 提示词审查 (Prompt Review)

### 1.1 `single.yaml` (Single Strategy)
*   **状态**: **正常**。已更新为新的三分类（1/0/待确定）标准。
*   **细节**: 包含了完整的 9 级空间层级列表和 Field 1 的决策规则。System Prompt 结构清晰。

### 1.2 `cot.yaml` (CoT Strategy)
*   **状态**: **正常**。已同步更新 Field 1 的判定逻辑（Check Decision Rules）。
*   **逻辑**: `<thinking>` 步骤引导模型依次检查更新意图、空间对象和空间层级，符合预期。

### 1.3 `stepwise.yaml` (Stepwise Strategy)
*   **状态**: **正常**。Step 1 的 Output Options 已明确列出 1, 0, 待确定。
*   **一致性**: Step 1, 2, 3 的定义与 `single.yaml` 保持一致。

### 1.4 `reflection.yaml` (Reflection Strategy)
*   **状态**: **需要微调**。
*   **问题**: `reflection_critique` 中的检查点 1 目前只提到了 "Urban Renewal MUST target EXISTING built-up areas"，没有显式提及新的“待确定”状态。虽然模型可能自己推断，但最好显式加入“Check if it falls into the '待确定' category (context/method only)”的提示，以增强纠错能力。

## 2. 代码逻辑审查 (Code Logic Review)

### 2.1 `single.py`
*   **逻辑**: 创建独立 Memory -> 发送 Prompt -> 解析 TAB 分隔输出。
*   **评价**: 逻辑正确，简洁高效。

### 2.2 `stepwise.py` & `stepwise_long.py`
*   **逻辑**: Step 1 (Context) -> Step 2 (No Context) -> Step 3 (No Context)。
*   **问题**: 在 Step 1 的解析中，使用了 `self.parse_single_output(resp1)`。
    *   `parse_single_output` 只是简单地返回非空行。
    *   **潜在风险**: 如果模型在 Step 1 输出 "1 (Yes)" 或 "Step 1: 1"，解析器可能无法精确提取纯数字 "1"。
    *   **建议**: 虽然提示词要求 "Output EXACTLY one line with ONE field"，但为了鲁棒性，建议在 `parse_single_output` 中增加正则清洗，提取 `1`, `0`, `待确定`。

### 2.3 `cot.py`
*   **逻辑**: 发送 Prompt -> 寻找最后一行 TAB 分隔数据 -> 解析。
*   **评价**: `final_line` 的查找逻辑（倒序查找非标签行）比较稳健，能有效跳过 `<thinking>` 部分。

### 2.4 `reflection.py`
*   **逻辑**: Round 1 -> Round 2 (Critique) -> 解析 Round 2。
*   **评价**: 逻辑正确。如果 Round 2 失败回退到 Round 1 的处理也很合理。

## 3. 修复计划

为了确保万无一失，我建议执行以下微调：

1.  **优化 `reflection.yaml`**: 更新 Critique Prompt，明确要求检查“待确定”的情况。
2.  **增强 `base.py` 解析逻辑**: 修改 `parse_single_output`，增加对“待确定”和纯数字的清洗逻辑，防止模型输出多余标点或解释文字。

请确认是否执行上述优化？
